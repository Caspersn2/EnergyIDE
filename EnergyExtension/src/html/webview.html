<!-- Inside header -->

<head>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<!-- This is body -->
<h2>Estimate Energy Consumption</h2>
</br>
<label for="types">Estimation Type:</label>
<select class="full-width selector" name="types" id="types">
  <option value="ml">Machine Learning (static)</option>
  <option value="energy_model">Energy Model (static)</option>
  <option value="rapl">RAPL (dynamic)</option>
</select>
</br>

<label for="functions">Methods(s) for Estimation:</label>
</br>
</br>
<!-- Function selector -->
<div class="selectBox" onclick="showCheckboxes()">
  <select class="multiSelector">
    <option id="selectText">Select an option</option>
  </select>
  <div class="overSelect"></div>
</div>
<div id="checkboxes">
  <label class="inRow"><input type="checkbox">No methods found in the .dll files. Try to press the reload button to
    check for new files and methods.</label>
</div>
</br>

<button type="button" class="full-width btn" id="reloadMethods" onclick="reloadMethods()">
  <i class="material-icons" style="font-size:12px; vertical-align: middle;">refresh</i>
  <span style="font-size:12px; vertical-align: middle;">Reload Methods</span>
  <i class="material-icons" style="font-size:12px; vertical-align: middle;">refresh</i>
</button>
</br>
</br>

<button id="activate-button" class="full-width btn" onclick="activate()">
  <i id="activate-button-icon" class="material-icons" style="font-size:12px; vertical-align: middle;">bolt</i>
  <span id="activate-button-text" style="font-size:12px; vertical-align: middle;">Begin Estimation</span>
  <i id="activate-button-icon" class="material-icons" style="font-size:12px; vertical-align: middle;">bolt</i>
</button>
</br>

<p id="calcText">Select function and click activate.</p>
<ul id="running-functions"></ul>
<button id="stop-button" style="display: none;" class="full-width btn btn-stop" onclick="stop()">Stop</button>

<script>

  const vscode = acquireVsCodeApi(); // acquireVsCodeApi can only be invoked once

  var classesShown = [];

  window.addEventListener("message", (event) => {
    const message = event.data;
    switch (message.command) {
      case "progress": // value = plannedMethods, classesPlanned, exceptionString, exceptionThrown
        let values = message.value;
        let container = document.getElementById("running-functions");
        container.innerHTML = "";

        values.PlannedMethods.forEach(method => { // Method = id, runsDone, plannedRuns, methodName, className, stage
          var methodHTML = document.createElement("li");
          methodHTML.id = method.Id;

          var label = document.createElement("label");
          label.innerText = method.MethodName;
          methodHTML.appendChild(label);

          var progressText = document.createElement("p");
          progressText.innerText = method.Stage + ": " + method.RunsDone + "/" + method.PlannedRuns + " = " + ((100 / method.PlannedRuns) * method.RunsDone).toFixed(2) + "%";
          methodHTML.appendChild(progressText);

          var progressBar = document.createElement("progress");
          progressBar.value = method.RunsDone;
          progressBar.max = method.PlannedRuns;
          progressBar.style = "width: 100%";
          methodHTML.appendChild(progressBar);

          container.appendChild(methodHTML);
        });

        break;

      case "done":
        var activateButton = document.getElementById("activate-button");
        activateButton.classList.remove("active");
        activateButton.disabled = false;

        var stopButton = document.getElementById("stop-button");
        stopButton.style.display = "none";

        break;

      case "methods":
        let methodGroups = message.value;
        classesShown = methodGroups;

        // Clear the dropdown
        let functionsDropdown = document.getElementById("checkboxes");
        functionsDropdown.innerHTML = "";

        // Add methods to the dropdown
        methodGroups.forEach((methodGroup) => {
          // Create the surrounding element
          let surround = document.createElement("div");

          // Create the grouplabel
          let groupLabel = document.createElement("label");
          groupLabel.for = methodGroup.ClassName;
          groupLabel.textContent = methodGroup.ClassName;
          groupLabel.classList.add("groupLabel");
          groupLabel.title = methodGroup.ClassName;

          // Create the checkbox for the group
          let groupCheck = document.createElement("input");
          groupCheck.type = "checkbox";
          groupCheck.id = methodGroup.ClassName;

          groupCheck.addEventListener("change", (event) => {
            this.groupSelected(methodGroup.ClassName);
          });
          groupLabel.insertBefore(groupCheck, groupLabel.childNodes[0]);
          surround.appendChild(groupLabel);

          // Inserts the methods as children to the group
          methodGroup.Methods.forEach((method) => {
            let option = document.createElement("label");
            option.for = method.Id;
            option.textContent = method.StringRepresentation;
            option.classList.add("inRow");
            option.classList.add("option");
            option.value = JSON.stringify(method);

            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = method.Id;
            checkbox.value = JSON.stringify(method);
            option.addEventListener("change", (event) => {
              this.updateNumSelected();
            });
            option.insertBefore(checkbox, option.childNodes[0]);
            surround.appendChild(option);
          });

          functionsDropdown.appendChild(surround);
        });
        break;
    }
  });

  function activate() {
    // change the color and text of activate button and disable it.
    var activateButton = document.getElementById("activate-button");
    activateButton.classList.add("active");
    activateButton.disabled = true;
    var buttonText = document.getElementById("activate-button-text");
    buttonText.textContent = "Estimating ..."

    // Show the stop button
    var stopButton = document.getElementById("stop-button");
    stopButton.style.display = "block";

    // Call the server to activate the selected methods.
    let selected = getSelectedMethods();
    let type = document.getElementById("types").value;

    vscode.postMessage({
      type: "activate",
      value: { methods: selected, type: type },
    });

    //TODO: Fix text
    document.getElementById("calcText").textContent = "Calculating: " + selected.map(s => s.ClassName).join(', ');
  }

  function reloadMethods() {
    let type = document.getElementById("types").value;
    type = type == "rapl" ? "dynamic" : "static";
    vscode.postMessage({
      type: "reloadMethods",
      value: { type: type }
    });
  }

  function stop() {
    vscode.postMessage({
      type: "stop",
      value: true
    });
  }

  var expanded = false;
  function showCheckboxes() {
    var checkboxes = document.getElementById("checkboxes");
    if (!expanded) {
      checkboxes.style.display = "block";
      expanded = true;
    } else {
      checkboxes.style.display = "none";
      expanded = false;
    }
  }

  function groupSelected(group) {
    let groupElement = document.getElementById(group);
    let check = groupElement.checked;
    let next = groupElement.parentNode.nextSibling;
    while (next) {
      let input = next.firstChild;
      if (check) {
        if (!input.checked) {
          input.checked = true;
        }
      } else {
        if (input.checked) {
          input.checked = false;
        }
      }
      next = next.nextSibling;
    }
    this.updateNumSelected();
  }

  // Gets the methods selected in the dropdown.
  // Returns an ActivateClass[] representing the selected
  function getSelectedMethods() {
    let selected = [];
    this.classesShown.forEach((c) => {
      let selectedMethods = []
      c.Methods.forEach((m) => {
        elm = document.getElementById(m.Id);
        if (elm.checked || elm.getAttribute("checked")) {
          selectedMethods.push(JSON.parse(elm.value));
        }
      });
      if (selectedMethods.length > 0) {
        selected.push({ ClassName: c.ClassName, AssemblyPath: c.AssemblyPath, Methods: selectedMethods })
      }
    });
    return selected;
  }

  function updateNumSelected() {
    let selected = getSelectedMethods().map(x => x.Methods);
    let counter = document.getElementById("selectText");
    counter.textContent = selected.length + " methods selected";
  }

</script>


<style>
  .full-width {
    width: 100%;
  }

  .progress-element {
    background-color: hotpink;
    flex-wrap: wrap;
    justify-content: space-between;
    display: flex;
  }

  .inRow {
    flex-wrap: nowrap;
    justify-content: right;
    display: flex;
  }

  .selector {
    background: var(--vscode-editor-background);
    color: var(--vscode-editor-color);
    margin-bottom: 1rem;
    margin-top: 1rem;
    padding: 0.3rem;
  }

  .multiSelector {
    background: var(--vscode-editor-background);
    color: var(--vscode-editor-color);
    padding: 0.3rem;
  }

  .active {
    background-color: green;
  }

  .btn {
    border-style: none;
    border-radius: 0.2rem;
    padding: 0.3rem;
    cursor: pointer;
  }

  .btn-stop:hover {
    background-color: red;
  }

  .option {
    padding-left: 1rem;
  }

  .multiselect {
    width: 200px;
  }

  .selectBox {
    position: relative;
  }

  .selectBox select {
    width: 100%;
  }

  .overSelect {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
  }

  #checkboxes {
    display: none;
    border: 1px #dadada solid;
  }

  #checkboxes label {
    display: block;
  }

  #checkboxes label:hover {
    background-color: #1e90ff;
  }

  .groupLabel {
    overflow: hidden;
  }
</style>