<!-- Inside header -->


<!-- This is body -->
<h2>Calcuate energy consumption</h2>
</br>
<label for="types">Type:</label>
</br>
<select class="full-width selector" name="types" id="types">
  <option value="ml">Machine Learning</option>
  <option value="rapl">RAPL</option>
</select>
</br>
<label for="functions">Select function:</label>
</br>

<!-- Function selector -->
<div class="selectBox" onclick="showCheckboxes()">
  <select class="multiSelector">
    <option id="selectText">Select an option</option>
  </select>
  <div class="overSelect"></div>
</div>
<div id="checkboxes">
  <label class="inRow"><input type="checkbox">something that is really long er some shit, i dunno. this meight be stupid and not worth it.</label>
</div>

<!-- <select class="full-width selector select-checkbox" name="functions" id="functions" onchange="if (this.selectedIndex) methodSelected();">
  <option value="nothingFound">Nothing found</option>
  <option value="something">something</option>
  <option value="Apple">Apple</option>
  <option value="Aligator">Aligator</option>
</select> -->


</br>
<button id="activate-button" class="full-width btn" onclick="activate()">Activate!</button>
</br>
<p id="calcText">Select function and click activate.</p>
<ul id="running-functions"></ul>

<script>
  const vscode = acquireVsCodeApi(); // acquireVsCodeApi can only be invoked once
  var methodsShown = [];
  window.addEventListener('message', event => {
    const message = event.data;
    switch(message.command){
      case 'progress':
        let values = message.value;
        let container = document.getElementById("running-functions");
        container.innerHTML = '';
        values.forEach(value => {
          var item = document.createElement("li");
          item.appendChild(document.createTextNode(value.functionName));
          item.appendChild(document.createTextNode(value.eta));
          item.classList.add('progress-element');
          container.appendChild(item);
        });
        break;
      
      case 'done':
        document.getElementById("activate-button").classList.remove("active");
        document.getElementById("calcText").textContent = "Done calculateing: 6mj or something";
        break;
      
      case 'methods':
        let methodGroups = message.value;
        this.methodsShown = message.value;
        let functionsDropdown = document.getElementById('checkboxes');
        functionsDropdown.innerHTML = "";
        methodGroups.forEach(methodGroup => {
          let surround = document.createElement('div');
          let groupLabel = document.createElement('label');
          groupLabel.for = methodGroup.key;
          groupLabel.textContent = methodGroup.key;
          groupLabel.classList.add("groupLabel");
          groupLabel.title = methodGroup.key;
          
          let groupCheck = document.createElement('input');
          groupCheck.type = "checkbox";
          groupCheck.id = methodGroup.key;
          
          groupCheck.addEventListener('change', (event) => {
            this.groupSelected(methodGroup.key);
          });
          groupLabel.insertBefore(groupCheck, groupLabel.childNodes[0]);
          surround.appendChild(groupLabel);

          methodGroup.value.forEach(method => {
            let option = document.createElement('label');
            option.for = method.id;
            option.textContent = method.name;
            option.classList.add("inRow");
            option.classList.add("option");
            
            let checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.id = method.id;
            option.addEventListener('change', (event) => {
              this.methodSelected(method.id);
            });
            option.insertBefore(checkbox, option.childNodes[0]);

            option.value = JSON.stringify(method);
            surround.appendChild(option);
          });
          
          functionsDropdown.appendChild(surround);
        });
        break;
    };
  });

  function methodSelected(id) {
    this.updateNumSelected();
  }

  function activate() {
    let functionName = document.getElementById("functions").value.name;
    let type = document.getElementById("types").value;
    document.getElementById("activate-button").classList.add("active");

    vscode.postMessage({ type: 'activate', value: { function: functionName, type: type }});
    
    // Maybe don't do this?
    document.getElementById("calcText").textContent = "Calculating: " + functionName;
  }

  var expanded = false;
  function showCheckboxes() {
    var checkboxes = document.getElementById("checkboxes");
    if (!expanded) {
      checkboxes.style.display = "block";
      expanded = true;
    } else {
      checkboxes.style.display = "none";
      expanded = false;
    }
  }

  function groupSelected(group){
    let groupElement = document.getElementById(group);
    let check = groupElement.checked;
    let next = groupElement.parentNode.nextSibling;
    while (next){
      let input = next.firstChild;
      if (check){
        if (!input.checked){
          input.checked = true;
        }
      }
      else {
        if (input.checked){
          input.checked = false;
        }
      }
      next = next.nextSibling;
    }
    this.updateNumSelected();
  }

  function updateNumSelected() {
    let selected = [];
    this.methodsShown.forEach(g => {
      g.value.forEach(m => {
        elm = document.getElementById(m.id);
        if (elm.checked || elm.getAttribute('checked')){
          selected.push(elm.value);
        }
      });
    });
    let counter = document.getElementById('selectText');
    counter.textContent = selected.length + " methods selected";
  }
</script>
<style>

.full-width {
  width: 100%;
}

.progress-element {
  background-color: hotpink;
  flex-wrap: wrap;
  justify-content: space-between;
  display: flex;
}

.inRow {
  flex-wrap: nowrap;
  justify-content: right;
  display: flex;
}

.selector {
  background: var(--vscode-editor-background);
  color: var(--vscode-editor-color);
  margin-bottom: 1rem;
  margin-top: 1rem;
  padding: 0.3rem;
}
.multiSelector {
  background: var(--vscode-editor-background);
  color: var(--vscode-editor-color);
  padding: 0.3rem;
}

.active {
  background-color: green;
}

.btn {
  border-style: none;
  border-radius: 0.2rem;
  padding: 0.3rem;
}

.option {
  padding-left: 1rem;
}

.multiselect {
  width: 200px;
}

.selectBox {
  position: relative;
}

.selectBox select {
  width: 100%;
}

.overSelect {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
}

#checkboxes {
  display: none;
  border: 1px #dadada solid;
}

#checkboxes label {
  display: block;
}

#checkboxes label:hover {
  background-color: #1e90ff;
}

.groupLabel {
  overflow: hidden;
}

</style>