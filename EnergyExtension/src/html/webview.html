<!-- Inside header -->

<head>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>
<!-- This is body -->
<h2>Estimate Energy Consumption</h2>
</br>
<label for="types">Estimation Type:</label>
<select class="full-width selector" name="types" id="types" onChange="reloadMethods()" )>
  <option value="ml">Machine Learning (static)</option>
  <option value="energy_model">Energy Model (static)</option>
  <option value="rapl">RAPL (dynamic)</option>
</select>
</br>

<label for="functions">Methods(s) for Estimation:</label>
</br>
<!-- Function selector -->
<div id="selector-container">
  <select id="function-selector" class="full-width selector" multiple size="15"></select>
</div>
</br>

<button type="button" class="full-width btn" id="reloadMethods" onclick="reloadMethods()">
  <i class="material-icons" style="font-size:12px; vertical-align: middle;">refresh</i>
  <span style="font-size:12px; vertical-align: middle;">Reload Methods</span>
  <i class="material-icons" style="font-size:12px; vertical-align: middle;">refresh</i>
</button>
</br>
</br>

<button id="activate-button" class="full-width btn" onclick="activate()">
  <i id="activate-button-icon" class="material-icons" style="font-size:12px; vertical-align: middle;">bolt</i>
  <span id="activate-button-text" style="font-size:12px; vertical-align: middle;">Begin Estimation</span>
  <i id="activate-button-icon" class="material-icons" style="font-size:12px; vertical-align: middle;">bolt</i>
</button>
</br>

<ul id="running-functions"></ul>

<script>

  const vscode = acquireVsCodeApi(); // acquireVsCodeApi can only be invoked once

  var classesShown = [];

  window.addEventListener("message", (event) => {
    const message = event.data;
    switch (message.command) {
      case "progress": // value = plannedMethods, classesPlanned, exceptionString, exceptionThrown
        let values = message.value;
        let container = document.getElementById("running-functions");
        container.innerHTML = "";

        values.PlannedMethods.forEach(method => { // Method = id, runsDone, plannedRuns, methodName, className, stage
          var label = document.createElement("label");
          label.innerText = "Method: " + method.MethodName;
          label.id = "progress-text"
          container.appendChild(label);

          var surroundDiv = document.createElement("div");
          surroundDiv.id = "progress";
          var percentage = ((100 / method.PlannedRuns) * method.RunsDone).toFixed(2) + "%";
          var percentText = document.createElement("span");
          percentText.id = "progress-text";
          percentText.innerText = method.RunsDone + "/" + method.PlannedRuns + " = " + percentage;
          var progressBar = document.createElement("div");
          progressBar.id = "bar";
          progressBar.style = "width: " + percentage;

          surroundDiv.appendChild(percentText);
          surroundDiv.appendChild(progressBar);
          container.appendChild(surroundDiv);
        });

        break;

      case "done":
        isActive = false;
        document.getElementById("activate-button-text").textContent = "Begin Estimation";
        document.getElementById("activate-button").classList.remove("active");
        break;

      case "methods":
        let methodGroups = message.value;
        classesShown = methodGroups;
        let type = document.getElementById("types").value;

        // Get selector and clear it
        var methodSelector = document.getElementById("selector-container").children[0];
        methodSelector.innerHTML = '';

        // Set size of selector
        let numMethods = methodGroups.map(x => x.Methods).flat().length + methodGroups.length;
        let size = 15 > numMethods ? numMethods : 15;
        methodSelector.setAttribute("size", size)
        //Add methods
        methodGroups.forEach((methodGroup) => {
          var optGroup = document.createElement('optgroup')
          optGroup.label = methodGroup.ClassName;
          methodGroup.Methods.forEach((method) => {
            var option = new Option(method.StringRepresentation, method.Id, false)
            option.addEventListener("change", (event) => {
              this.updateNumSelected();
            });
            option.title = method.StringRepresentation; // Tooltip
            optGroup.appendChild(option)
          })
          methodSelector.appendChild(optGroup)
        })
        break;
    }
  });

  var isActive = false;
  function activate() {
    // change the color and text of activate button and disable it.
    var activateButton = document.getElementById("activate-button");
    var buttonText = document.getElementById("activate-button-text")
    if (!isActive) {
      isActive = true;
      buttonText.textContent = "Estimating ... Click to stop.";
      activateButton.classList.add("active");

      // Call the server to activate the selected methods.
      let selected = getSelectedMethods();
      let type = document.getElementById("types").value;

      vscode.postMessage({
        type: "activate",
        value: { methods: selected, type: type },
      });
    }
    else {
      isActive = false;
      buttonText.textContent = "Stopping ...";
      activateButton.classList.remove("active");
      vscode.postMessage({
        type: "stop",
        value: true
      });
      document.getElementById("activate-button-text").textContent = "Begin Estimation";
    }

    //TODO: Fix text
    document.getElementById("calcText").textContent = "Calculating: " + selected.map(s => s.ClassName).join(', ');
  }

  function reloadMethods() {
    let type = document.getElementById("types").value;
    type = type == "rapl" ? "dynamic" : "static";
    vscode.postMessage({
      type: "reloadMethods",
      value: { type: type }
    });
  }

  // Gets the methods selected in the dropdown.
  // Returns an ActivateClass[] representing the selected
  function getSelectedMethods() {
    let selectElement = document.getElementById('function-selector')
    let selectedValues = Array.from(selectElement.selectedOptions)
      .map(option => String(option.value))
    let selected = [];
    this.classesShown.forEach((c) => {
      let selectedMethods = []
      c.Methods.forEach((m) => {
        if (selectedValues.includes(String(m.Id))) {
          selectedMethods.push(m);
        }
      });
      if (selectedMethods.length > 0) {
        selected.push({ ClassName: c.ClassName, AssemblyPath: c.AssemblyPath, Methods: selectedMethods })
      }
    });
    return selected;
  }

  function updateNumSelected() {
    let selected = getSelectedMethods().map(x => x.Methods).flat();
    let counter = document.getElementById("selectText");
    if (selected.length == 1) {
      counter.textContent = selected[0].StringRepresentation;
    }
    else {
      counter.textContent = selected.length + " method(s) selected";
    }
  }

</script>


<style>
  .full-width {
    width: 100%;
  }

  .inRow {
    flex-wrap: nowrap;
    justify-content: right;
    display: flex;
  }

  .selector {
    background: var(--vscode-dropdown-listBackground);
    color: var(--vscode-dropdown-foreground);
    border-color: var(--vscode-dropdown-border);
    margin-bottom: 1rem;
    margin-top: 1rem;
    padding: 0.3rem;
  }

  .btn {
    border-style: none;
    border-radius: 0.2rem;
    padding: 0.3rem;
    cursor: pointer;
    background-color: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
  }

  .active {
    background-color: var(--vscode-button-hoverBackground);
  }

  .option {
    background-color: var(--vscode-dropdown-Background);
    padding-left: 1rem;
  }

  ul {
    margin: 1rem 0 1rem 0;
    padding: 0;
  }

  #progress {
    margin-bottom: 1rem;
    width: 100%;
    position: relative;
  }

  #progress-text {
    color: var(--vscode-button-foreground);
  }

  #bar {
    height: 5px;
    border-radius: 0.2rem;
    border-color: var(--vscode-dropdown-border);
    background-color: var(--vscode-button-background);
  }

  .overSelect {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
  }
</style>
